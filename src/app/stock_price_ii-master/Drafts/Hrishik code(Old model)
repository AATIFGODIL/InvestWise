import pandas as pd
from yahoofinancials import YahooFinancials
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.ensemble import GradientBoostingRegressor
from sklearn.metrics import r2_score
from datetime import datetime, timedelta

class PortfolioForecastService:
    def __init__(self):
        self.end_date = None
        self.start_date = None
        self.historical_data = None
        self.random_state = 42  # Fixed random state for consistency

    def update(self, yahoo):
        self.end_date = datetime.now().strftime('%Y-%m-%d')
        self.start_date = (datetime.now() - timedelta(days=5*365)).strftime('%Y-%m-%d')
        self.historical_data = yahoo.get_historical_price_data(self.start_date, self.end_date, 'monthly')

    def get_historical_data(self, symbol):
        return pd.DataFrame(self.historical_data[symbol]['prices'])

    def get_forecast_data(self, symbol, historical_data):
        X = historical_data[['formatted_date', 'open', 'high', 'low', 'volume']].copy()
        X['formatted_date'] = pd.to_datetime(X['formatted_date']).astype(int) / 10**9
        y = historical_data['close']

        # Random state is placed here
        X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=self.random_state)

        scaler = StandardScaler()
        X_train_scaled = scaler.fit_transform(X_train)
        X_test_scaled = scaler.transform(X_test)

        # Random state fixed here
        regressor = GradientBoostingRegressor(random_state=self.random_state)
        regressor.fit(X_train_scaled, y_train)
        y_pred = regressor.predict(X_test_scaled)

        score = r2_score(y_test, y_pred)

        return y_pred, score

    def get_portfolio_forecast(self, portfolio):
        forecast_data = {}
        accuracy_scores = {}
        yahoo = YahooFinancials(portfolio)
        self.update(yahoo)
        for symbol in portfolio:
            historical_data = self.get_historical_data(symbol)
            forecast, score = self.get_forecast_data(symbol, historical_data)
            forecast_data[symbol] = forecast
            accuracy_scores[symbol] = score
        return forecast_data, accuracy_scores


service = PortfolioForecastService()
forecast, accuracy = service.get_portfolio_forecast(["NVDA"])
print(accuracy)

